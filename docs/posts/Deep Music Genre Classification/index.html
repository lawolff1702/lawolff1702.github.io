<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lukka Wolff">
<meta name="dcterms.date" content="2025-05-12">
<meta name="description" content="Deep Music Genre Classification in Python">

<title>Deep Music Genre Classification – Machine Learning Blog - Lukka Wolff</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-afd1c537f28ba892ec3c7a1a10902170.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Machine Learning Blog - Lukka Wolff</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/lawolff1702"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/lukka-wolff/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Deep Music Genre Classification</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Natural Language Processing</div>
    <div class="quarto-category">Neural Networks</div>
    <div class="quarto-category">Deep Learning</div>
    <div class="quarto-category">In Progress</div>
  </div>
  </div>

<div>
  <div class="description">
    Deep Music Genre Classification in Python
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Lukka Wolff </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 12, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="abstract" class="level1">
<h1>Abstract</h1>
<p>– Enter Here –</p>
</section>
<section id="data" class="level1">
<h1>Data</h1>
<div id="7dad640f" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchinfo <span class="im">import</span> summary</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># for train-test split</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># for suppressing bugged warnings from torchinfo</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, category <span class="op">=</span> <span class="pp">UserWarning</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># tokenizers from HuggingFace</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> transformers <span class="im">import</span> BertTokenizer</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># for building condensed vocab sets</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># from torchtext.vocab import build_vocab_from_iterator</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>c:\Users\lukka\anaconda3\envs\ml-0451\lib\site-packages\tqdm\auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm</code></pre>
</div>
</div>
<p>We are loading in a <a href="https://www.kaggle.com/datasets/saurabhshahane/music-dataset-1950-to-2019">Kaggle dataset</a> that contains information about music made between the years 1950 and 2019 collected through Spotify. The dataset contains lyrics, artist info, track names, etc. Importantly it also includes music metadata like sadness, danceability, loudness, acousticness, etc.</p>
<div id="9f297de2" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/PhilChodrow/PIC16B/master/datasets/tcc_ceds_music.csv"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lets have a look at some of the raw data!</p>
<div id="58bdc5ec" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Unnamed: 0</th>
<th data-quarto-table-cell-role="th">artist_name</th>
<th data-quarto-table-cell-role="th">track_name</th>
<th data-quarto-table-cell-role="th">release_date</th>
<th data-quarto-table-cell-role="th">genre</th>
<th data-quarto-table-cell-role="th">lyrics</th>
<th data-quarto-table-cell-role="th">len</th>
<th data-quarto-table-cell-role="th">dating</th>
<th data-quarto-table-cell-role="th">violence</th>
<th data-quarto-table-cell-role="th">world/life</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">sadness</th>
<th data-quarto-table-cell-role="th">feelings</th>
<th data-quarto-table-cell-role="th">danceability</th>
<th data-quarto-table-cell-role="th">loudness</th>
<th data-quarto-table-cell-role="th">acousticness</th>
<th data-quarto-table-cell-role="th">instrumentalness</th>
<th data-quarto-table-cell-role="th">valence</th>
<th data-quarto-table-cell-role="th">energy</th>
<th data-quarto-table-cell-role="th">topic</th>
<th data-quarto-table-cell-role="th">age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>mukesh</td>
<td>mohabbat bhi jhoothi</td>
<td>1950</td>
<td>pop</td>
<td>hold time feel break feel untrue convince spea...</td>
<td>95</td>
<td>0.000598</td>
<td>0.063746</td>
<td>0.000598</td>
<td>...</td>
<td>0.380299</td>
<td>0.117175</td>
<td>0.357739</td>
<td>0.454119</td>
<td>0.997992</td>
<td>0.901822</td>
<td>0.339448</td>
<td>0.137110</td>
<td>sadness</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>4</td>
<td>frankie laine</td>
<td>i believe</td>
<td>1950</td>
<td>pop</td>
<td>believe drop rain fall grow believe darkest ni...</td>
<td>51</td>
<td>0.035537</td>
<td>0.096777</td>
<td>0.443435</td>
<td>...</td>
<td>0.001284</td>
<td>0.001284</td>
<td>0.331745</td>
<td>0.647540</td>
<td>0.954819</td>
<td>0.000002</td>
<td>0.325021</td>
<td>0.263240</td>
<td>world/life</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>6</td>
<td>johnnie ray</td>
<td>cry</td>
<td>1950</td>
<td>pop</td>
<td>sweetheart send letter goodbye secret feel bet...</td>
<td>24</td>
<td>0.002770</td>
<td>0.002770</td>
<td>0.002770</td>
<td>...</td>
<td>0.002770</td>
<td>0.225422</td>
<td>0.456298</td>
<td>0.585288</td>
<td>0.840361</td>
<td>0.000000</td>
<td>0.351814</td>
<td>0.139112</td>
<td>music</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>10</td>
<td>pérez prado</td>
<td>patricia</td>
<td>1950</td>
<td>pop</td>
<td>kiss lips want stroll charm mambo chacha merin...</td>
<td>54</td>
<td>0.048249</td>
<td>0.001548</td>
<td>0.001548</td>
<td>...</td>
<td>0.225889</td>
<td>0.001548</td>
<td>0.686992</td>
<td>0.744404</td>
<td>0.083935</td>
<td>0.199393</td>
<td>0.775350</td>
<td>0.743736</td>
<td>romantic</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>12</td>
<td>giorgos papadopoulos</td>
<td>apopse eida oneiro</td>
<td>1950</td>
<td>pop</td>
<td>till darling till matter know till dream live ...</td>
<td>48</td>
<td>0.001350</td>
<td>0.001350</td>
<td>0.417772</td>
<td>...</td>
<td>0.068800</td>
<td>0.001350</td>
<td>0.291671</td>
<td>0.646489</td>
<td>0.975904</td>
<td>0.000246</td>
<td>0.597073</td>
<td>0.394375</td>
<td>romantic</td>
<td>1.0</td>
</tr>
</tbody>
</table>

<p>5 rows × 31 columns</p>
</div>
</div>
</div>
<p>Here is a brief look at how many songs we have in each represented genre.</p>
<div id="e2300648" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>df.groupby(<span class="st">"genre"</span>).size()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>genre
blues      4604
country    5445
hip hop     904
jazz       3845
pop        7042
reggae     2498
rock       4034
dtype: int64</code></pre>
</div>
</div>
<p>This is a pretty large number of songs to classify… and some genres I personally dont care for. So, to make the dataframe more manageable and applicable to me personally, we are going to narrow down to only observe reggae, hip hop, rock and jazz.</p>
<div id="aaaf27ad" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>genres <span class="op">=</span> {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hip hop"</span>   : <span class="dv">0</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"jazz"</span> : <span class="dv">1</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"reggae"</span> : <span class="dv">2</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rock"</span> : <span class="dv">3</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[df[<span class="st">"genre"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="kw">in</span> genres.keys())]</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Unnamed: 0</th>
<th data-quarto-table-cell-role="th">artist_name</th>
<th data-quarto-table-cell-role="th">track_name</th>
<th data-quarto-table-cell-role="th">release_date</th>
<th data-quarto-table-cell-role="th">genre</th>
<th data-quarto-table-cell-role="th">lyrics</th>
<th data-quarto-table-cell-role="th">len</th>
<th data-quarto-table-cell-role="th">dating</th>
<th data-quarto-table-cell-role="th">violence</th>
<th data-quarto-table-cell-role="th">world/life</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">sadness</th>
<th data-quarto-table-cell-role="th">feelings</th>
<th data-quarto-table-cell-role="th">danceability</th>
<th data-quarto-table-cell-role="th">loudness</th>
<th data-quarto-table-cell-role="th">acousticness</th>
<th data-quarto-table-cell-role="th">instrumentalness</th>
<th data-quarto-table-cell-role="th">valence</th>
<th data-quarto-table-cell-role="th">energy</th>
<th data-quarto-table-cell-role="th">topic</th>
<th data-quarto-table-cell-role="th">age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">17091</td>
<td>54304</td>
<td>gene ammons</td>
<td>it's the talk of the town</td>
<td>1950</td>
<td>jazz</td>
<td>lovers sweethearts hard understand know happen...</td>
<td>61</td>
<td>0.001096</td>
<td>0.001096</td>
<td>0.001096</td>
<td>...</td>
<td>0.319570</td>
<td>0.001096</td>
<td>0.352323</td>
<td>0.620388</td>
<td>0.868474</td>
<td>0.235830</td>
<td>0.430132</td>
<td>0.282260</td>
<td>sadness</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17092</td>
<td>54305</td>
<td>gene ammons</td>
<td>you go to my head</td>
<td>1950</td>
<td>jazz</td>
<td>head linger like haunt refrain spin round brai...</td>
<td>48</td>
<td>0.001754</td>
<td>0.340964</td>
<td>0.001754</td>
<td>...</td>
<td>0.001754</td>
<td>0.001754</td>
<td>0.379400</td>
<td>0.638541</td>
<td>0.907630</td>
<td>0.900810</td>
<td>0.221970</td>
<td>0.184159</td>
<td>violence</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">17093</td>
<td>54307</td>
<td>bud powell</td>
<td>yesterdays</td>
<td>1950</td>
<td>jazz</td>
<td>music speak start hear musicians like dizzy gi...</td>
<td>107</td>
<td>0.001144</td>
<td>0.001144</td>
<td>0.074762</td>
<td>...</td>
<td>0.001144</td>
<td>0.097082</td>
<td>0.489873</td>
<td>0.467400</td>
<td>0.992972</td>
<td>0.927126</td>
<td>0.334295</td>
<td>0.228204</td>
<td>music</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17094</td>
<td>54311</td>
<td>tony bennett</td>
<td>stranger in paradise</td>
<td>1950</td>
<td>jazz</td>
<td>hand stranger paradise lose wonderland strange...</td>
<td>41</td>
<td>0.002105</td>
<td>0.180524</td>
<td>0.002105</td>
<td>...</td>
<td>0.527429</td>
<td>0.002105</td>
<td>0.179032</td>
<td>0.559470</td>
<td>0.983936</td>
<td>0.001781</td>
<td>0.086974</td>
<td>0.235211</td>
<td>sadness</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">17095</td>
<td>54313</td>
<td>dean martin</td>
<td>zing-a zing-a zing boom</td>
<td>1950</td>
<td>jazz</td>
<td>zinga zinga zinga zinga zinga zinga zinga zing...</td>
<td>160</td>
<td>0.001253</td>
<td>0.001253</td>
<td>0.001253</td>
<td>...</td>
<td>0.425721</td>
<td>0.001253</td>
<td>0.580851</td>
<td>0.687409</td>
<td>0.655622</td>
<td>0.000000</td>
<td>0.936109</td>
<td>0.418400</td>
<td>sadness</td>
<td>1.0</td>
</tr>
</tbody>
</table>

<p>5 rows × 31 columns</p>
</div>
</div>
</div>
<div id="bf486021" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"genre"</span>] <span class="op">=</span> df[<span class="st">"genre"</span>].<span class="bu">apply</span>(genres.get)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Unnamed: 0</th>
<th data-quarto-table-cell-role="th">artist_name</th>
<th data-quarto-table-cell-role="th">track_name</th>
<th data-quarto-table-cell-role="th">release_date</th>
<th data-quarto-table-cell-role="th">genre</th>
<th data-quarto-table-cell-role="th">lyrics</th>
<th data-quarto-table-cell-role="th">len</th>
<th data-quarto-table-cell-role="th">dating</th>
<th data-quarto-table-cell-role="th">violence</th>
<th data-quarto-table-cell-role="th">world/life</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">sadness</th>
<th data-quarto-table-cell-role="th">feelings</th>
<th data-quarto-table-cell-role="th">danceability</th>
<th data-quarto-table-cell-role="th">loudness</th>
<th data-quarto-table-cell-role="th">acousticness</th>
<th data-quarto-table-cell-role="th">instrumentalness</th>
<th data-quarto-table-cell-role="th">valence</th>
<th data-quarto-table-cell-role="th">energy</th>
<th data-quarto-table-cell-role="th">topic</th>
<th data-quarto-table-cell-role="th">age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">17091</td>
<td>54304</td>
<td>gene ammons</td>
<td>it's the talk of the town</td>
<td>1950</td>
<td>1</td>
<td>lovers sweethearts hard understand know happen...</td>
<td>61</td>
<td>0.001096</td>
<td>0.001096</td>
<td>0.001096</td>
<td>...</td>
<td>0.319570</td>
<td>0.001096</td>
<td>0.352323</td>
<td>0.620388</td>
<td>0.868474</td>
<td>0.235830</td>
<td>0.430132</td>
<td>0.282260</td>
<td>sadness</td>
<td>1.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17092</td>
<td>54305</td>
<td>gene ammons</td>
<td>you go to my head</td>
<td>1950</td>
<td>1</td>
<td>head linger like haunt refrain spin round brai...</td>
<td>48</td>
<td>0.001754</td>
<td>0.340964</td>
<td>0.001754</td>
<td>...</td>
<td>0.001754</td>
<td>0.001754</td>
<td>0.379400</td>
<td>0.638541</td>
<td>0.907630</td>
<td>0.900810</td>
<td>0.221970</td>
<td>0.184159</td>
<td>violence</td>
<td>1.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">17093</td>
<td>54307</td>
<td>bud powell</td>
<td>yesterdays</td>
<td>1950</td>
<td>1</td>
<td>music speak start hear musicians like dizzy gi...</td>
<td>107</td>
<td>0.001144</td>
<td>0.001144</td>
<td>0.074762</td>
<td>...</td>
<td>0.001144</td>
<td>0.097082</td>
<td>0.489873</td>
<td>0.467400</td>
<td>0.992972</td>
<td>0.927126</td>
<td>0.334295</td>
<td>0.228204</td>
<td>music</td>
<td>1.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17094</td>
<td>54311</td>
<td>tony bennett</td>
<td>stranger in paradise</td>
<td>1950</td>
<td>1</td>
<td>hand stranger paradise lose wonderland strange...</td>
<td>41</td>
<td>0.002105</td>
<td>0.180524</td>
<td>0.002105</td>
<td>...</td>
<td>0.527429</td>
<td>0.002105</td>
<td>0.179032</td>
<td>0.559470</td>
<td>0.983936</td>
<td>0.001781</td>
<td>0.086974</td>
<td>0.235211</td>
<td>sadness</td>
<td>1.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">17095</td>
<td>54313</td>
<td>dean martin</td>
<td>zing-a zing-a zing boom</td>
<td>1950</td>
<td>1</td>
<td>zinga zinga zinga zinga zinga zinga zinga zing...</td>
<td>160</td>
<td>0.001253</td>
<td>0.001253</td>
<td>0.001253</td>
<td>...</td>
<td>0.425721</td>
<td>0.001253</td>
<td>0.580851</td>
<td>0.687409</td>
<td>0.655622</td>
<td>0.000000</td>
<td>0.936109</td>
<td>0.418400</td>
<td>sadness</td>
<td>1.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28367</td>
<td>82447</td>
<td>mack 10</td>
<td>10 million ways</td>
<td>2019</td>
<td>0</td>
<td>cause fuck leave scar tick tock clock come kno...</td>
<td>78</td>
<td>0.001350</td>
<td>0.001350</td>
<td>0.001350</td>
<td>...</td>
<td>0.065664</td>
<td>0.001350</td>
<td>0.889527</td>
<td>0.759711</td>
<td>0.062549</td>
<td>0.000000</td>
<td>0.751649</td>
<td>0.695686</td>
<td>obscene</td>
<td>0.014286</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">28368</td>
<td>82448</td>
<td>m.o.p.</td>
<td>ante up (robbin hoodz theory)</td>
<td>2019</td>
<td>0</td>
<td>minks things chain ring braclets yap fame come...</td>
<td>67</td>
<td>0.001284</td>
<td>0.001284</td>
<td>0.035338</td>
<td>...</td>
<td>0.001284</td>
<td>0.001284</td>
<td>0.662082</td>
<td>0.789580</td>
<td>0.004607</td>
<td>0.000002</td>
<td>0.922712</td>
<td>0.797791</td>
<td>obscene</td>
<td>0.014286</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28369</td>
<td>82449</td>
<td>nine</td>
<td>whutcha want?</td>
<td>2019</td>
<td>0</td>
<td>get ban get ban stick crack relax plan attack ...</td>
<td>77</td>
<td>0.001504</td>
<td>0.154302</td>
<td>0.168988</td>
<td>...</td>
<td>0.001504</td>
<td>0.001504</td>
<td>0.663165</td>
<td>0.726970</td>
<td>0.104417</td>
<td>0.000001</td>
<td>0.838211</td>
<td>0.767761</td>
<td>obscene</td>
<td>0.014286</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">28370</td>
<td>82450</td>
<td>will smith</td>
<td>switch</td>
<td>2019</td>
<td>0</td>
<td>check check yeah yeah hear thing call switch g...</td>
<td>67</td>
<td>0.001196</td>
<td>0.001196</td>
<td>0.001196</td>
<td>...</td>
<td>0.001196</td>
<td>0.001196</td>
<td>0.883028</td>
<td>0.786888</td>
<td>0.007027</td>
<td>0.000503</td>
<td>0.508450</td>
<td>0.885882</td>
<td>obscene</td>
<td>0.014286</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">28371</td>
<td>82451</td>
<td>jeezy</td>
<td>r.i.p.</td>
<td>2019</td>
<td>0</td>
<td>remix killer alive remix thriller trap bitch s...</td>
<td>83</td>
<td>0.001012</td>
<td>0.075202</td>
<td>0.001012</td>
<td>...</td>
<td>0.001012</td>
<td>0.033995</td>
<td>0.828875</td>
<td>0.674794</td>
<td>0.015862</td>
<td>0.000000</td>
<td>0.475474</td>
<td>0.492477</td>
<td>obscene</td>
<td>0.014286</td>
</tr>
</tbody>
</table>

<p>11281 rows × 31 columns</p>
</div>
</div>
</div>
<p>The base rate on our classification is the proportion of the data set occupied by the largest label class:</p>
<div id="7065f720" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>df.groupby(<span class="st">"genre"</span>).size() <span class="op">/</span> <span class="bu">len</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>genre
0    0.080135
1    0.340839
2    0.221434
3    0.357592
dtype: float64</code></pre>
</div>
</div>
<p>If we always guessed category 3, then we would expect an accuracy of <strong>roughly 36%</strong>. So, our task will be to see whether we can train a model to beat this.</p>
<p>As we try to predict the genre of the track, we will use lyrics alongside some other engineered features (metadata) that we define below.</p>
<div id="6bccea61" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>engineered_features <span class="op">=</span> [<span class="st">'dating'</span>, <span class="st">'violence'</span>, <span class="st">'world/life'</span>, <span class="st">'night/time'</span>,<span class="st">'shake the audience'</span>,<span class="st">'family/gospel'</span>, <span class="st">'romantic'</span>, <span class="st">'communication'</span>,<span class="st">'obscene'</span>, <span class="st">'music'</span>, <span class="st">'movement/places'</span>, <span class="st">'light/visual perceptions'</span>,<span class="st">'family/spiritual'</span>, <span class="st">'like/girls'</span>, <span class="st">'sadness'</span>, <span class="st">'feelings'</span>, <span class="st">'danceability'</span>,<span class="st">'loudness'</span>, <span class="st">'acousticness'</span>, <span class="st">'instrumentalness'</span>, <span class="st">'valence'</span>, <span class="st">'energy'</span>]      </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our models will only need these engineered features, lyrics, and our target value which will be <em>genre</em> so we can throw them all into the same dataframe and use slicing to access different parts later.</p>
<div id="e9e570cd" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df_clean<span class="op">=</span> df[engineered_features <span class="op">+</span> [<span class="st">'lyrics'</span>, <span class="st">'genre'</span>]].copy()</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>df_clean.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">dating</th>
<th data-quarto-table-cell-role="th">violence</th>
<th data-quarto-table-cell-role="th">world/life</th>
<th data-quarto-table-cell-role="th">night/time</th>
<th data-quarto-table-cell-role="th">shake the audience</th>
<th data-quarto-table-cell-role="th">family/gospel</th>
<th data-quarto-table-cell-role="th">romantic</th>
<th data-quarto-table-cell-role="th">communication</th>
<th data-quarto-table-cell-role="th">obscene</th>
<th data-quarto-table-cell-role="th">music</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">sadness</th>
<th data-quarto-table-cell-role="th">feelings</th>
<th data-quarto-table-cell-role="th">danceability</th>
<th data-quarto-table-cell-role="th">loudness</th>
<th data-quarto-table-cell-role="th">acousticness</th>
<th data-quarto-table-cell-role="th">instrumentalness</th>
<th data-quarto-table-cell-role="th">valence</th>
<th data-quarto-table-cell-role="th">energy</th>
<th data-quarto-table-cell-role="th">lyrics</th>
<th data-quarto-table-cell-role="th">genre</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">17091</td>
<td>0.001096</td>
<td>0.001096</td>
<td>0.001096</td>
<td>0.001096</td>
<td>0.036316</td>
<td>0.001096</td>
<td>0.001096</td>
<td>0.460773</td>
<td>0.086498</td>
<td>0.001096</td>
<td>...</td>
<td>0.319570</td>
<td>0.001096</td>
<td>0.352323</td>
<td>0.620388</td>
<td>0.868474</td>
<td>0.235830</td>
<td>0.430132</td>
<td>0.282260</td>
<td>lovers sweethearts hard understand know happen...</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17092</td>
<td>0.001754</td>
<td>0.340964</td>
<td>0.001754</td>
<td>0.001754</td>
<td>0.001754</td>
<td>0.001754</td>
<td>0.131872</td>
<td>0.001754</td>
<td>0.001754</td>
<td>0.001754</td>
<td>...</td>
<td>0.001754</td>
<td>0.001754</td>
<td>0.379400</td>
<td>0.638541</td>
<td>0.907630</td>
<td>0.900810</td>
<td>0.221970</td>
<td>0.184159</td>
<td>head linger like haunt refrain spin round brai...</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">17093</td>
<td>0.001144</td>
<td>0.001144</td>
<td>0.074762</td>
<td>0.046173</td>
<td>0.001144</td>
<td>0.018789</td>
<td>0.001144</td>
<td>0.001655</td>
<td>0.001144</td>
<td>0.421734</td>
<td>...</td>
<td>0.001144</td>
<td>0.097082</td>
<td>0.489873</td>
<td>0.467400</td>
<td>0.992972</td>
<td>0.927126</td>
<td>0.334295</td>
<td>0.228204</td>
<td>music speak start hear musicians like dizzy gi...</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17094</td>
<td>0.002105</td>
<td>0.180524</td>
<td>0.002105</td>
<td>0.002105</td>
<td>0.002105</td>
<td>0.002105</td>
<td>0.002105</td>
<td>0.201965</td>
<td>0.002105</td>
<td>0.002105</td>
<td>...</td>
<td>0.527429</td>
<td>0.002105</td>
<td>0.179032</td>
<td>0.559470</td>
<td>0.983936</td>
<td>0.001781</td>
<td>0.086974</td>
<td>0.235211</td>
<td>hand stranger paradise lose wonderland strange...</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">17095</td>
<td>0.001253</td>
<td>0.001253</td>
<td>0.001253</td>
<td>0.001253</td>
<td>0.001253</td>
<td>0.081126</td>
<td>0.001253</td>
<td>0.111951</td>
<td>0.001253</td>
<td>0.268737</td>
<td>...</td>
<td>0.425721</td>
<td>0.001253</td>
<td>0.580851</td>
<td>0.687409</td>
<td>0.655622</td>
<td>0.000000</td>
<td>0.936109</td>
<td>0.418400</td>
<td>zinga zinga zinga zinga zinga zinga zinga zing...</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>5 rows × 24 columns</p>
</div>
</div>
</div>
<p>Finally, we will perform a train-validation split to later evaluate our data</p>
<div id="f5d16bf8" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df_train, df_val <span class="op">=</span> train_test_split(df_clean,shuffle <span class="op">=</span> <span class="va">True</span>, test_size <span class="op">=</span> <span class="fl">0.2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="text-vectorization" class="level1">
<h1>Text Vectorization</h1>
<p>We now need to <em>vectorize</em> the lyrics. We’re going to use <strong>tokenization</strong> to break up the lyrics into a sequence of tokens, and then vectorize that sequence.</p>
<p>We will be using a tokenizer imported from HuggingFace.</p>
<div id="df0d265f" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>tokenizer <span class="op">=</span> BertTokenizer.from_pretrained(<span class="st">"google-bert/bert-base-uncased"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For our purposes it’s more convenient to assign an <em>integer</em> to each token, which we can do like this:</p>
<div id="a11810f1" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>encoded <span class="op">=</span> tokenizer(<span class="st">"I love reggae music!"</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>encoded</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>{'input_ids': [101, 1045, 2293, 15662, 2189, 999, 102], 'token_type_ids': [0, 0, 0, 0, 0, 0, 0], 'attention_mask': [1, 1, 1, 1, 1, 1, 1]}</code></pre>
</div>
</div>
<p>To do the reverse, we can use the <code>.decode</code> method of the tokenizer:</p>
<div id="4e21097f" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>tokenizer.decode(encoded[<span class="st">"input_ids"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>'[CLS] i love reggae music! [SEP]'</code></pre>
</div>
</div>
<p>Here is some code to help us prepare our dataset with encodings. A lot of our lyrics are different lengths so we will pad the shorter ones with 0s and truncate others that are especially long. We will make use of the torch <code>Dataset</code> class to help manage our data.</p>
<div id="067e73fe" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>max_len <span class="op">=</span> <span class="dv">512</span> <span class="co"># BERT capacity</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> preprocess(df, tokenizer, max_len):</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    lyrics_tokens <span class="op">=</span> tokenizer(<span class="bu">list</span>(df[<span class="st">"lyrics"</span>]), padding<span class="op">=</span><span class="st">"max_length"</span>, truncation<span class="op">=</span><span class="va">True</span>, max_length<span class="op">=</span>max_len)[<span class="st">"input_ids"</span>]</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    engineered <span class="op">=</span> df[engineered_features].values.tolist()</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> <span class="bu">list</span>(df[<span class="st">"genre"</span>])</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lyrics_tokens, engineered, y</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TextDataFromDF(Dataset):</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, df):</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lyrics_tokens, <span class="va">self</span>.engineered_feats, <span class="va">self</span>.y <span class="op">=</span> preprocess(df, tokenizer, max_len)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, ix):</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.lyrics_tokens[ix], <span class="va">self</span>.engineered_feats[ix], <span class="va">self</span>.y[ix]</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lets make our encoded datasets!</p>
<div id="09224851" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>train_data <span class="op">=</span> TextDataFromDF(df_train)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>val_data   <span class="op">=</span> TextDataFromDF(df_val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is what a single songs information looks like now:</p>
<div id="ff257b8e" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>X_tokens, X_feats, y <span class="op">=</span> train_data[<span class="dv">1</span>]</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(X_tokens, X_feats)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[101, 2372, 2113, 21209, 6887, 16585, 2477, 2111, 8501, 3613, 9266, 2213, 9680, 2444, 9152, 23033, 2015, 10675, 2015, 4401, 2991, 4533, 4952, 11898, 10432, 12170, 9102, 6510, 8081, 4485, 2729, 10667, 14033, 6510, 2131, 2477, 2175, 4485, 2131, 2518, 3861, 2272, 2420, 2208, 16371, 4246, 7047, 8046, 4485, 2215, 4485, 4248, 4355, 7281, 7579, 6841, 16360, 8091, 4485, 4982, 4503, 14255, 23344, 2227, 2131, 3947, 3238, 2444, 11565, 10020, 2102, 3305, 2514, 2665, 3259, 2192, 2518, 2903, 2066, 8554, 10421, 7200, 5223, 2342, 2757, 11274, 4372, 14540, 10696, 2111, 2219, 3828, 2111, 13660, 3240, 102, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] [0.0011961722985867, 0.1300521675514939, 0.1951359532512352, 0.0011961722561089, 0.0011961723204168, 0.0011961722655141, 0.0011961722799619, 0.1710064773999869, 0.3944457875450848, 0.0011961722772403, 0.0011961723013686, 0.0011961723181082, 0.0522687272336512, 0.0011961722965877, 0.0011961723815529, 0.0415406469256242, 0.4476334885735947, 0.7206368740866087, 0.0736938490902099, 0.0, 0.6589035449299256, 0.6446335461127515]
2</code></pre>
</div>
</div>
<p>We are going to be feeding data in in batches, so we will need a dataloader which necessitates a collate function to ensure our we are imputing tensors of the right size.</p>
<div id="a751a3bd" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> collate(data):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    tokens <span class="op">=</span> torch.tensor([d[<span class="dv">0</span>] <span class="cf">for</span> d <span class="kw">in</span> data], dtype<span class="op">=</span>torch.<span class="bu">long</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    engineered <span class="op">=</span> torch.tensor([d[<span class="dv">1</span>] <span class="cf">for</span> d <span class="kw">in</span> data], dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> torch.tensor([d[<span class="dv">2</span>] <span class="cf">for</span> d <span class="kw">in</span> data], dtype<span class="op">=</span>torch.<span class="bu">long</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (tokens, engineered), y</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>train_loader <span class="op">=</span> DataLoader(train_data, batch_size<span class="op">=</span><span class="dv">8</span>, shuffle<span class="op">=</span><span class="va">True</span>, collate_fn <span class="op">=</span> collate)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>val_loader <span class="op">=</span> DataLoader(val_data, batch_size<span class="op">=</span><span class="dv">8</span>, shuffle<span class="op">=</span><span class="va">True</span>, collate_fn <span class="op">=</span> collate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is what a batch of data looks like. The predictor data is now a tensor in which the entries give token indices, padded with 0s and another tensor with the values of our engineered features. For visualization purposes we’ll show only the first 2 rows:</p>
<div id="b18de88b" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>X, y <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(train_loader))</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>X[:<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>(tensor([[  101,  2621,  4553,  ...,     0,     0,     0],
         [  101,  2668, 14740,  ...,     0,     0,     0],
         [  101,  2305,  2272,  ...,     0,     0,     0],
         ...,
         [  101,  2051,  2621,  ...,     0,     0,     0],
         [  101,  2051,  2202,  ...,     0,     0,     0],
         [  101,  5949,  2773,  ...,     0,     0,     0]]),
 tensor([[2.5063e-03, 2.5063e-03, 3.3226e-01, 9.8139e-02, 2.5063e-03, 2.5063e-03,
          2.5063e-03, 2.5063e-03, 2.5063e-03, 1.2809e-01, 2.5063e-03, 2.5063e-03,
          2.5063e-03, 2.8335e-01, 2.5063e-03, 2.5063e-03, 5.5594e-01, 7.7276e-01,
          2.0883e-02, 1.1235e-05, 2.8174e-01, 4.7846e-01],
         [1.8797e-03, 5.0473e-01, 1.8797e-03, 1.8797e-03, 3.7594e-02, 3.9971e-02,
          1.8797e-03, 1.8797e-03, 1.8797e-03, 1.8797e-03, 1.8797e-03, 1.8797e-03,
          1.3261e-01, 1.8797e-03, 2.2307e-01, 1.8797e-03, 8.1155e-01, 7.5999e-01,
          8.7248e-02, 2.5304e-03, 5.6513e-01, 6.5364e-01],
         [1.9493e-03, 1.9493e-03, 3.4622e-01, 1.9493e-03, 1.9493e-03, 1.9493e-03,
          1.9493e-03, 1.9493e-03, 1.9493e-03, 1.9493e-03, 2.8898e-01, 3.3361e-01,
          1.9493e-03, 1.9493e-03, 1.9493e-03, 1.9493e-03, 6.1118e-01, 5.5086e-01,
          9.5181e-01, 1.8725e-01, 3.4151e-01, 2.2320e-01],
         [5.7208e-04, 5.7208e-04, 5.1883e-02, 5.7208e-04, 6.8732e-02, 2.8145e-02,
          5.7208e-04, 2.5657e-01, 3.6477e-01, 5.7208e-04, 2.2247e-01, 5.7208e-04,
          5.7208e-04, 5.7208e-04, 5.7208e-04, 5.7208e-04, 7.4764e-01, 6.9715e-01,
          1.6867e-01, 0.0000e+00, 8.4233e-01, 4.8046e-01],
         [1.9611e-02, 3.9300e-01, 2.4161e-01, 8.9206e-04, 1.8294e-02, 7.0961e-02,
          8.9206e-04, 8.9206e-04, 8.9206e-04, 8.9206e-04, 8.9206e-04, 1.4598e-01,
          4.5708e-02, 5.5025e-02, 8.9206e-04, 8.9206e-04, 8.0180e-01, 6.7451e-01,
          5.6827e-05, 9.4838e-01, 9.0210e-01, 7.9379e-01],
         [1.0526e-03, 1.0526e-03, 1.0526e-03, 3.2379e-01, 1.0526e-03, 1.0526e-03,
          9.0729e-02, 1.7966e-01, 1.0526e-03, 1.0713e-01, 1.0526e-03, 2.5740e-01,
          1.0526e-03, 1.0526e-03, 1.0526e-03, 2.7609e-02, 2.0286e-01, 6.0398e-01,
          9.4478e-01, 5.6883e-05, 5.1731e-02, 2.8426e-01],
         [1.5038e-03, 1.8747e-01, 1.5038e-03, 1.6175e-01, 1.5038e-03, 1.5038e-03,
          1.5038e-03, 1.5038e-03, 4.1537e-02, 1.5038e-03, 1.5038e-03, 1.5038e-03,
          1.5038e-03, 1.5038e-03, 5.2697e-01, 1.5038e-03, 5.4403e-01, 7.8607e-01,
          6.8374e-06, 8.3806e-01, 3.3739e-01, 9.4795e-01],
         [2.9240e-03, 2.9240e-03, 2.9240e-03, 1.0013e-01, 2.9240e-03, 2.9240e-03,
          2.9240e-03, 2.9240e-03, 2.9240e-03, 1.7470e-01, 2.9240e-03, 2.9240e-03,
          2.9240e-03, 9.0332e-02, 4.7758e-01, 2.9240e-03, 6.3609e-01, 7.2769e-01,
          5.7932e-01, 3.3603e-01, 6.4963e-01, 7.6075e-01]]))</code></pre>
</div>
</div>
<div id="13b5056f" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>y[:<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>tensor([3, 2])</code></pre>
</div>
</div>
</section>
<section id="model-building" class="level1">
<h1>Model Building</h1>
<p>We are going to train <strong>three</strong> neural networks to classify our genres.</p>
<ul>
<li>Using Lyrics to Classify</li>
<li>Using Engineered Features (Metadata) to Classify</li>
<li>Using Lyrics and Metadata to Classify</li>
</ul>
<p>Lets build a model for classifying genres based on lyrics first.</p>
<section id="lyrical-classification" class="level2">
<h2 class="anchored" data-anchor-id="lyrical-classification">Lyrical Classification</h2>
<div id="aba4f4e1" class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TextClassificationModel(nn.Module):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,vocab_size, embedding_dim, max_len, num_class):</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.embedding <span class="op">=</span> nn.Embedding(vocab_size<span class="op">+</span><span class="dv">1</span>, embedding_dim)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> nn.Dropout(<span class="fl">0.2</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc_flat <span class="op">=</span> nn.Linear(embedding_dim, embedding_dim)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc <span class="op">=</span> nn.Linear(embedding_dim, num_class) <span class="co"># max_len*embedding_dim</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.relu <span class="op">=</span> nn.ReLU()</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.embedding(x)</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.fc_flat(x)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.relu(x)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.dropout(x)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> x.mean(axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x = torch.flatten(x, 1)</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.fc(x)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span>(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our model begins with the embedding layer where each word is looked up in an embedding table and turned into a learned vector of size <code>embedding_dim</code>. Immediately after embedding, we pass each token’s embedding through a small fully-connected layer then a ReLU activation, the fully connected layer lets the model learn a richer representation before pooling. We then pass the embedding into a dropout layer where 20% of the embedding vectors are randomly zeroed. This is a form of regularization step meant to help us not be over-reliant on certain tokens. Our mean-pool layer reduces our dimension by averaging all token embeddings so each song is now a fixed-size vector. Finally, our linear layer gives us our probabilities for each genre.</p>
<p>Let’s have a look at it!</p>
<div id="ec0d5f4d" class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>vocab_size <span class="op">=</span> <span class="bu">len</span>(tokenizer.vocab)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>embedding_dim <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>num_class <span class="op">=</span> <span class="bu">len</span>(genres)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>text_model <span class="op">=</span> TextClassificationModel(vocab_size, embedding_dim, max_len, num_class).to(device)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="30b7a935" class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>summary(text_model, input_Size <span class="op">=</span> (<span class="dv">8</span>, max_len))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="109">
<pre><code>=================================================================
Layer (type:depth-idx)                   Param #
=================================================================
TextClassificationModel                  --
├─Embedding: 1-1                         976,736
├─Dropout: 1-2                           --
├─Linear: 1-3                            1,056
├─Linear: 1-4                            132
├─ReLU: 1-5                              --
=================================================================
Total params: 977,924
Trainable params: 977,924
Non-trainable params: 0
=================================================================</code></pre>
</div>
</div>
<p>We have a huge amount of trainable parameters! We could make this architecture more lightweight by changing the size of our embedding dimension.</p>
<p>Below, we define our training loop which can be used for all of our three models that we will define shortly. We define an accuracy function that we will use to evaluate the accuracy of our model and another to evaluate the per class accuracy.</p>
<div id="cda0fbd9" class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(model, dataloader, mode<span class="op">=</span><span class="st">"lyrics"</span>, vocab_freq<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">1e-3</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    loss_fn <span class="op">=</span> torch.nn.CrossEntropyLoss()</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    epoch_start_time <span class="op">=</span> time.time()</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># keep track of some counts for measuring accuracy</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    total_acc, total_count <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> X, y <span class="kw">in</span> dataloader:</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># unpack and move to device</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>        tokens, engineered <span class="op">=</span> X</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> y.to(device)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mode <span class="op">==</span> <span class="st">"lyrics"</span>:</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>            <span class="co">"""</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co">            if vocab_freq:</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="co">                vocab = build_vocab_from_iterator(tokens, specials=["&lt;unk&gt;"], min_freq = 50)</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="co">                tokens = torch.tensor(vocab)</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co">            """</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> tokens.to(device)</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> mode <span class="op">==</span> <span class="st">"engineered"</span>:</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> engineered.to(device)</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> X</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># zero gradients</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># form prediction on batch</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>        predicted_label <span class="op">=</span> model(data)</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># evaluate loss on prediction</span></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> loss_fn(predicted_label, y)</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># compute gradient</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># take an optimization step</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># for printing accuracy</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>        total_acc <span class="op">+=</span> (predicted_label.argmax(<span class="dv">1</span>) <span class="op">==</span> y).<span class="bu">sum</span>().item()</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>        total_count <span class="op">+=</span> y.size(<span class="dv">0</span>)</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'| epoch </span><span class="sc">{</span>epoch<span class="sc">:3d}</span><span class="ss"> | train accuracy </span><span class="sc">{</span>total_acc<span class="op">/</span>total_count<span class="sc">:8.3f}</span><span class="ss"> | time: </span><span class="sc">{</span>time<span class="sc">.</span>time() <span class="op">-</span> epoch_start_time<span class="sc">:5.2f}</span><span class="ss">s'</span>)</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> accuracy(model, dataloader, mode<span class="op">=</span><span class="st">"lyrics"</span>):</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>    total_acc, total_count <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> X, y <span class="kw">in</span> dataloader:</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># unpack and move to device</span></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>            tokens, engineered <span class="op">=</span> X</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> y.to(device)</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> mode <span class="op">==</span> <span class="st">"lyrics"</span>:</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>                data <span class="op">=</span> tokens.to(device)</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> mode <span class="op">==</span> <span class="st">"engineered"</span>:</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>                data <span class="op">=</span> engineered.to(device)</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> mode <span class="op">==</span> <span class="st">"both"</span>:</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>                data <span class="op">=</span> X</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>            predicted_label <span class="op">=</span> model(data)</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>            total_acc <span class="op">+=</span> (predicted_label.argmax(<span class="dv">1</span>) <span class="op">==</span> y).<span class="bu">sum</span>().item()</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>            total_count <span class="op">+=</span> y.size(<span class="dv">0</span>)</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> total_acc<span class="op">/</span>total_count</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> per_class_accuracy(model, dataloader, mode<span class="op">=</span><span class="st">"lyrics"</span>, num_classes<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>    correct <span class="op">=</span> [<span class="dv">0</span>] <span class="op">*</span> num_classes</span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>    total   <span class="op">=</span> [<span class="dv">0</span>] <span class="op">*</span> num_classes</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> X, y <span class="kw">in</span> dataloader:</span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a>            tokens, engineered <span class="op">=</span> X</span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> y.to(device)</span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-74"><a href="#cb32-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> mode <span class="op">==</span> <span class="st">"lyrics"</span>:</span>
<span id="cb32-75"><a href="#cb32-75" aria-hidden="true" tabindex="-1"></a>                data <span class="op">=</span> tokens.to(device)</span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> mode <span class="op">==</span> <span class="st">"engineered"</span>:</span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a>                data <span class="op">=</span> engineered.to(device)</span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a>                data <span class="op">=</span> X</span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(data)</span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a>            preds <span class="op">=</span> outputs.argmax(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> cls <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(correct)):</span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a>                mask <span class="op">=</span> (y <span class="op">==</span> cls)</span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a>                total[cls] <span class="op">+=</span> mask.<span class="bu">sum</span>().item()</span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a>                correct[cls] <span class="op">+=</span> ((preds <span class="op">==</span> cls) <span class="op">&amp;</span> mask).<span class="bu">sum</span>().item()</span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a>        cls: (correct[cls] <span class="op">/</span> total[cls] <span class="cf">if</span> total[cls] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span>)</span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> cls <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(correct))</span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a>    }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have those functions, lets jump right in and see how our model does when training on lyrics!</p>
<div id="b5303ff7" class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>EPOCHS <span class="op">=</span> <span class="dv">25</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, EPOCHS <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    train(text_model, train_loader, <span class="st">"lyrics"</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"     test accuracy  "</span>, accuracy(text_model, val_loader))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>| epoch   1 | train accuracy    0.379 | time:  4.47s
     test accuracy   0.3540097474523704
| epoch   2 | train accuracy    0.398 | time:  3.97s
     test accuracy   0.39787328311918474
| epoch   3 | train accuracy    0.425 | time:  3.94s
     test accuracy   0.4262295081967213
| epoch   4 | train accuracy    0.457 | time:  4.03s
     test accuracy   0.42977403633141337
| epoch   5 | train accuracy    0.498 | time:  4.06s
     test accuracy   0.46256092157731504
| epoch   6 | train accuracy    0.556 | time:  3.77s
     test accuracy   0.4980062029242357
| epoch   7 | train accuracy    0.600 | time:  3.75s
     test accuracy   0.538325210456358
| epoch   8 | train accuracy    0.642 | time:  3.64s
     test accuracy   0.5578201151971643
| epoch   9 | train accuracy    0.674 | time:  3.64s
     test accuracy   0.5604785112981834
| epoch  10 | train accuracy    0.695 | time:  3.67s
     test accuracy   0.5746566238369517
| epoch  11 | train accuracy    0.712 | time:  3.68s
     test accuracy   0.5813026140894993
| epoch  12 | train accuracy    0.729 | time:  3.74s
     test accuracy   0.5795303500221533
| epoch  13 | train accuracy    0.745 | time:  4.02s
     test accuracy   0.5724412937527692
| epoch  14 | train accuracy    0.757 | time:  3.94s
     test accuracy   0.5777580859548073
| epoch  15 | train accuracy    0.767 | time:  4.04s
     test accuracy   0.5764288879042977
| epoch  16 | train accuracy    0.782 | time:  3.85s
     test accuracy   0.5746566238369517
| epoch  17 | train accuracy    0.795 | time:  3.86s
     test accuracy   0.5755427558706248
| epoch  18 | train accuracy    0.799 | time:  3.91s
     test accuracy   0.5684536996012406
| epoch  19 | train accuracy    0.813 | time:  4.09s
     test accuracy   0.5755427558706248
| epoch  20 | train accuracy    0.821 | time:  3.99s
     test accuracy   0.5737704918032787
| epoch  21 | train accuracy    0.831 | time:  4.46s
     test accuracy   0.5693398316349136
| epoch  22 | train accuracy    0.840 | time:  4.20s
     test accuracy   0.5742135578201152
| epoch  23 | train accuracy    0.849 | time:  4.23s
     test accuracy   0.5622507753655295
| epoch  24 | train accuracy    0.857 | time:  4.39s
     test accuracy   0.561807709348693
| epoch  25 | train accuracy    0.859 | time:  4.26s
     test accuracy   0.562693841382366</code></pre>
</div>
</div>
<div id="3e236043" class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>accuracy(text_model, val_loader)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="112">
<pre><code>0.5666814355338945</code></pre>
</div>
</div>
<p>An <strong>accuracy around 56%</strong> may not seem all that great at first glance… however, lets remember our base rate was 36%, so despite the fact that we don’t have a particularly high accuracy we can still say that this model is successful!</p>
<p>Let’s look at our accuracy on each of our genres. A quick reminder that our genre keys are: - hip hop: 0 - jazz: 1 - reggae: 2 - rock: 3</p>
<div id="7446aa6e" class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>per_class_accuracy(text_model, val_loader, mode<span class="op">=</span><span class="st">"lyrics"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="135">
<pre><code>{0: 0.47701149425287354,
 1: 0.5816326530612245,
 2: 0.5031055900621118,
 3: 0.6090686274509803}</code></pre>
</div>
</div>
<p>Even our weakest genre (hip hop at around 48%) comfortably exceeds the base rate! Our model is indeed learning useful signals from the lyrics. Our best performances were on jazz and rock that may suggest that those lyrics have more distinct stylistic patterns. Hip hop and reggae, on the other hand, may have suffered because of slang or patois lyrics or possibly thematic overlap.</p>
</section>
<section id="engineered-features-classification" class="level2">
<h2 class="anchored" data-anchor-id="engineered-features-classification">Engineered Features Classification</h2>
<p>Let’s tackle using our engineered features to try and determine song genres!</p>
<div id="3c49c4b4" class="cell" data-execution_count="113">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MetadataClassificationModel(nn.Module):</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_features, num_class):</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pipeline <span class="op">=</span> nn.Sequential(</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>            nn.Linear(num_features, <span class="dv">18</span>), </span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">18</span>, <span class="dv">12</span>), </span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">12</span>, <span class="dv">8</span>), </span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">8</span>, num_class)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.pipeline(x)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict(<span class="va">self</span>, x): </span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.score(x) <span class="op">&gt;</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is a pretty simple architecture for our engineered features of which there are twenty-two. We are using a series of fully-connected linear layers, each punctuated by a ReLU nonlinearity activation function.</p>
<div id="c92120b4" class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>num_features <span class="op">=</span> <span class="bu">len</span>(engineered_features)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>meta_model <span class="op">=</span> MetadataClassificationModel(num_features, num_class).to(device)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>summary(meta_model, input_Size <span class="op">=</span> (<span class="dv">8</span>, max_len))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="114">
<pre><code>=================================================================
Layer (type:depth-idx)                   Param #
=================================================================
MetadataClassificationModel              --
├─Sequential: 1-1                        --
│    └─Linear: 2-1                       414
│    └─ReLU: 2-2                         --
│    └─Linear: 2-3                       228
│    └─ReLU: 2-4                         --
│    └─Linear: 2-5                       104
│    └─ReLU: 2-6                         --
│    └─Linear: 2-7                       36
=================================================================
Total params: 782
Trainable params: 782
Non-trainable params: 0
=================================================================</code></pre>
</div>
</div>
<p>This model is pretty lightweight compared to the lyric based model. Lets see how it performs!</p>
<div id="3f986713" class="cell" data-execution_count="115">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>EPOCHS <span class="op">=</span> <span class="dv">25</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, EPOCHS <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    train(meta_model, train_loader, <span class="st">"engineered"</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"     test accuracy  "</span>, accuracy(meta_model, val_loader, <span class="st">"engineered"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>| epoch   1 | train accuracy    0.459 | time:  4.19s
     test accuracy   0.5002215330084182
| epoch   2 | train accuracy    0.589 | time:  4.00s
     test accuracy   0.615861763402747
| epoch   3 | train accuracy    0.636 | time:  4.65s
     test accuracy   0.6278245458573327
| epoch   4 | train accuracy    0.643 | time:  3.95s
     test accuracy   0.6371289322108994
| epoch   5 | train accuracy    0.645 | time:  3.90s
     test accuracy   0.6371289322108994
| epoch   6 | train accuracy    0.650 | time:  3.75s
     test accuracy   0.640230394328755
| epoch   7 | train accuracy    0.649 | time:  3.73s
     test accuracy   0.6357997341603899
| epoch   8 | train accuracy    0.652 | time:  3.78s
     test accuracy   0.642002658396101
| epoch   9 | train accuracy    0.649 | time:  3.51s
     test accuracy   0.6468763845813026
| epoch  10 | train accuracy    0.651 | time:  3.73s
     test accuracy   0.640230394328755
| epoch  11 | train accuracy    0.649 | time:  3.52s
     test accuracy   0.6513070447496677
| epoch  12 | train accuracy    0.654 | time:  3.54s
     test accuracy   0.641116526362428
| epoch  13 | train accuracy    0.654 | time:  3.74s
     test accuracy   0.6504209127159947
| epoch  14 | train accuracy    0.655 | time:  3.39s
     test accuracy   0.6526362428001772
| epoch  15 | train accuracy    0.656 | time:  3.48s
     test accuracy   0.6424457244129376
| epoch  16 | train accuracy    0.654 | time:  3.31s
     test accuracy   0.6464333185644661
| epoch  17 | train accuracy    0.657 | time:  3.27s
     test accuracy   0.6451041205139566
| epoch  18 | train accuracy    0.654 | time:  3.38s
     test accuracy   0.6442179884802836
| epoch  19 | train accuracy    0.658 | time:  3.29s
     test accuracy   0.642002658396101
| epoch  20 | train accuracy    0.660 | time:  3.32s
     test accuracy   0.6446610544971201
| epoch  21 | train accuracy    0.658 | time:  3.24s
     test accuracy   0.6477625166149756
| epoch  22 | train accuracy    0.657 | time:  3.14s
     test accuracy   0.6482055826318122
| epoch  23 | train accuracy    0.658 | time:  3.21s
     test accuracy   0.6477625166149756
| epoch  24 | train accuracy    0.656 | time:  3.17s
     test accuracy   0.6455471865307931
| epoch  25 | train accuracy    0.655 | time:  3.09s
     test accuracy   0.6530793088170137</code></pre>
</div>
</div>
<div id="5e474de1" class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>accuracy(meta_model, val_loader, <span class="st">"engineered"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="116">
<pre><code>0.6530793088170137</code></pre>
</div>
</div>
<p>Woah! Only using metadata, we achieved <strong>around 65% accuracy</strong>! This much better than our base rate, and higher than the lyrics only classification approach.</p>
<div id="a022208f" class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>per_class_accuracy(meta_model, val_loader, mode<span class="op">=</span><span class="st">"engineered"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="137">
<pre><code>{0: 0.5689655172413793,
 1: 0.6224489795918368,
 2: 0.6128364389233955,
 3: 0.7242647058823529}</code></pre>
</div>
</div>
<p>We are also outperforming all of our base rates for each genre! Once again rock is our highest performer (around 72%) showing its distinction from other genres in categories like <code>instrumentalness</code>, <code>energy</code>, <code>movement/places</code>, etc.</p>
</section>
<section id="combined-feature-classification" class="level2">
<h2 class="anchored" data-anchor-id="combined-feature-classification">Combined Feature Classification</h2>
<p>We have now explored successful approaches using lyrics and using metadata. Lets see how we perform when we combine the two!</p>
<div id="eba8a02f" class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CombinedNet(nn.Module):</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, vocab_size, embedding_dim, num_class, num_features):</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># engineered features pipeline</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.eng_pipeline <span class="op">=</span> nn.Sequential(</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>            nn.Linear(num_features, <span class="dv">18</span>), </span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">18</span>, <span class="dv">12</span>), </span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">12</span>, <span class="dv">8</span>)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># text pipeline </span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.embedding <span class="op">=</span> nn.Embedding(vocab_size<span class="op">+</span><span class="dv">1</span>, embedding_dim)</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.relu <span class="op">=</span> nn.ReLU()</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc <span class="op">=</span> nn.Linear(embedding_dim, <span class="dv">8</span>)</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># combine the two pipelines</span></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.combine <span class="op">=</span> nn.Sequential(</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">16</span>, <span class="dv">12</span>), </span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">12</span>, <span class="dv">8</span>), </span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">8</span>, num_class)</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>        x_text, x_eng <span class="op">=</span> x</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>        x_text <span class="op">=</span> x_text.to(device)  </span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>        x_eng <span class="op">=</span> x_eng.to(device)</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># text pipeline:</span></span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>        x_text <span class="op">=</span> <span class="va">self</span>.embedding(x_text)</span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>        x_text <span class="op">=</span> <span class="va">self</span>.relu(x_text)</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>        x_text <span class="op">=</span> x_text.mean(axis <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>        x_text <span class="op">=</span> <span class="va">self</span>.fc(x_text)</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># engineered features pipeline:</span></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>        x_eng <span class="op">=</span> <span class="va">self</span>.eng_pipeline(x_eng)</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># then, combine them with: </span></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>        x_comb <span class="op">=</span> torch.cat([x_text, x_eng], dim <span class="op">=</span> <span class="dv">1</span>).to(device)</span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># pass x_comb through a couple more fully-connected layers and return output</span></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.combine(x_comb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The main ideas from the other pipelines remain. We first train separately following similar procedures to above, then we concatenate the features and pass them through several more fully-connected layers. Notably changes come in our text pipeline where we removed a fully connected layer and our dropout. These changes were a result of trail and error testing. Additionally, we bring our separate pipelines together before they are compressed back into our four-class classification.</p>
<div id="a0f95593" class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>combined_model <span class="op">=</span> CombinedNet(vocab_size, embedding_dim, num_class, num_features).to(device)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>summary(combined_model, input_Size <span class="op">=</span> (<span class="dv">8</span>, max_len))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="118">
<pre><code>=================================================================
Layer (type:depth-idx)                   Param #
=================================================================
CombinedNet                              --
├─Sequential: 1-1                        --
│    └─Linear: 2-1                       414
│    └─ReLU: 2-2                         --
│    └─Linear: 2-3                       228
│    └─ReLU: 2-4                         --
│    └─Linear: 2-5                       104
├─Embedding: 1-2                         976,736
├─ReLU: 1-3                              --
├─Linear: 1-4                            264
├─Sequential: 1-5                        --
│    └─Linear: 2-6                       204
│    └─ReLU: 2-7                         --
│    └─Linear: 2-8                       104
│    └─ReLU: 2-9                         --
│    └─Linear: 2-10                      36
=================================================================
Total params: 978,090
Trainable params: 978,090
Non-trainable params: 0
=================================================================</code></pre>
</div>
</div>
<p>Evidently, our model once again has a huge amount of trainable parameters. Lets see how they do!</p>
<div id="06377472" class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>EPOCHS <span class="op">=</span> <span class="dv">25</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, EPOCHS <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    train(combined_model, train_loader, <span class="st">"both"</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"     test accuracy  "</span>, accuracy(combined_model, val_loader, <span class="st">"both"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>| epoch   1 | train accuracy    0.495 | time:  5.70s
     test accuracy   0.5423128046078866
| epoch   2 | train accuracy    0.564 | time:  5.37s
     test accuracy   0.5560478511298184
| epoch   3 | train accuracy    0.571 | time:  5.38s
     test accuracy   0.5724412937527692
| epoch   4 | train accuracy    0.584 | time:  5.38s
     test accuracy   0.5799734160389898
| epoch   5 | train accuracy    0.594 | time:  5.33s
     test accuracy   0.5516171909614532
| epoch   6 | train accuracy    0.611 | time:  5.45s
     test accuracy   0.5990252547629596
| epoch   7 | train accuracy    0.631 | time:  5.34s
     test accuracy   0.6322552060256978
| epoch   8 | train accuracy    0.644 | time:  5.38s
     test accuracy   0.615861763402747
| epoch   9 | train accuracy    0.654 | time:  5.48s
     test accuracy   0.6473194505981391
| epoch  10 | train accuracy    0.669 | time:  5.75s
     test accuracy   0.6464333185644661
| epoch  11 | train accuracy    0.677 | time:  6.30s
     test accuracy   0.6566238369517058
| epoch  12 | train accuracy    0.692 | time:  5.92s
     test accuracy   0.6544085068675233
| epoch  13 | train accuracy    0.699 | time:  6.66s
     test accuracy   0.6575099689853788
| epoch  14 | train accuracy    0.711 | time:  6.78s
     test accuracy   0.6575099689853788
| epoch  15 | train accuracy    0.720 | time:  7.07s
     test accuracy   0.6326982720425344
| epoch  16 | train accuracy    0.729 | time:  7.26s
     test accuracy   0.66371289322109
| epoch  17 | train accuracy    0.741 | time:  7.66s
     test accuracy   0.6548515728843598
| epoch  18 | train accuracy    0.748 | time: 10.54s
     test accuracy   0.6526362428001772
| epoch  19 | train accuracy    0.759 | time:  9.17s
     test accuracy   0.6570669029685423
| epoch  20 | train accuracy    0.765 | time:  8.58s
     test accuracy   0.6641559592379265
| epoch  21 | train accuracy    0.776 | time:  6.94s
     test accuracy   0.6495347806823216
| epoch  22 | train accuracy    0.784 | time:  6.50s
     test accuracy   0.6486486486486487
| epoch  23 | train accuracy    0.789 | time:  6.38s
     test accuracy   0.66371289322109
| epoch  24 | train accuracy    0.800 | time:  6.19s
     test accuracy   0.6544085068675233
| epoch  25 | train accuracy    0.811 | time:  6.24s
     test accuracy   0.6260522817899867</code></pre>
</div>
</div>
<div id="0b789e66" class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>accuracy(combined_model, val_loader, <span class="st">"both"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="120">
<pre><code>0.6260522817899867</code></pre>
</div>
</div>
<p>After twenty-five epochs, we achieved an accuracy of <strong>around 62%</strong> which is slightly disappointing. If we look closely at the evolution of the our testing accuracy, we were steadily in the region of <strong>around 65%</strong> for a while. This drop may be a part of the training process or may be a reflection of the beginning of our <em>model overfitting</em> to the training data.</p>
<div id="fd55933c" class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>per_class_accuracy(combined_model, val_loader, mode<span class="op">=</span><span class="st">"both"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="138">
<pre><code>{0: 0.6839080459770115,
 1: 0.4872448979591837,
 2: 0.6977225672877847,
 3: 0.7046568627450981}</code></pre>
</div>
</div>
<p>Curse you Jazz!</p>
</section>
</section>
<section id="closing-remarks" class="level1">
<h1>Closing Remarks</h1>
<hr>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>